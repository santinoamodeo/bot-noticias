<!DOCTYPE html>
<html lang="es" data-theme="light">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>The News Bot</title>
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700;900&family=DM+Sans:wght@300;400;500&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg: #f4f1eb;
      --ink: #1a1208;
      --accent: #c8392b;
      --muted: #8a7f72;
      --card-bg: #fff;
      --border: #d6cfc4;
      --tag-bg: #1a1208;
      --tag-color: #f4f1eb;
      --search-bg: #1a1208;
      --cat-bg: #f4f1eb;
      --cat-border: #d6cfc4;
      --cat-hover: #1a1208;
      --cat-hover-color: #f4f1eb;
    }

    [data-theme="dark"] {
      --bg: #111018;
      --ink: #f0ece0;
      --accent: #e05444;
      --muted: #7a7568;
      --card-bg: #1c1b26;
      --border: #2e2c3a;
      --tag-bg: #f0ece0;
      --tag-color: #111018;
      --search-bg: #0a0a10;
      --cat-bg: #1c1b26;
      --cat-border: #2e2c3a;
      --cat-hover: #f0ece0;
      --cat-hover-color: #111018;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: 'DM Sans', sans-serif;
      background: var(--bg);
      color: var(--ink);
      min-height: 100vh;
      transition: background 0.3s, color 0.3s;
    }

    /* ‚îÄ‚îÄ MASTHEAD ‚îÄ‚îÄ */
    .masthead {
      border-bottom: 3px solid var(--ink);
      padding: 16px 40px 0;
      transition: border-color 0.3s;
    }

    .masthead-top {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding-bottom: 12px;
      border-bottom: 1px solid var(--border);
      margin-bottom: 12px;
    }

    .date-line {
      font-size: 0.72rem;
      letter-spacing: 0.15em;
      text-transform: uppercase;
      color: var(--muted);
      font-weight: 500;
    }

    .masthead-controls {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .fav-toggle {
      font-size: 0.72rem;
      letter-spacing: 0.1em;
      text-transform: uppercase;
      color: var(--muted);
      font-weight: 500;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 6px 12px;
      border: 1px solid var(--border);
      background: transparent;
      transition: all 0.2s;
      font-family: 'DM Sans', sans-serif;
    }

    .fav-toggle:hover, .fav-toggle.active {
      background: var(--accent);
      border-color: var(--accent);
      color: #fff;
    }

    .theme-btn {
      background: none;
      border: 1px solid var(--border);
      color: var(--ink);
      cursor: pointer;
      padding: 6px 10px;
      font-size: 1rem;
      line-height: 1;
      transition: all 0.2s;
    }

    .theme-btn:hover { border-color: var(--ink); }

    /* ‚îÄ‚îÄ USER AUTH AREA ‚îÄ‚îÄ */
    .user-auth {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .user-info {
      display: none;
      align-items: center;
      gap: 10px;
    }

    .user-avatar {
      width: 30px;
      height: 30px;
      border-radius: 50%;
      border: 1px solid var(--border);
      object-fit: cover;
    }

    .user-name {
      font-size: 0.75rem;
      font-weight: 500;
      color: var(--ink);
      letter-spacing: 0.04em;
      max-width: 120px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .btn-logout {
      font-size: 0.68rem;
      letter-spacing: 0.1em;
      text-transform: uppercase;
      color: var(--muted);
      font-weight: 500;
      cursor: pointer;
      padding: 5px 10px;
      border: 1px solid var(--border);
      background: transparent;
      transition: all 0.2s;
      font-family: 'DM Sans', sans-serif;
    }

    .btn-logout:hover {
      border-color: var(--accent);
      color: var(--accent);
    }

    .btn-login-trigger {
      font-size: 0.72rem;
      letter-spacing: 0.1em;
      text-transform: uppercase;
      font-weight: 500;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 6px 14px;
      border: 1px solid var(--ink);
      background: var(--ink);
      color: var(--bg);
      transition: all 0.2s;
      font-family: 'DM Sans', sans-serif;
    }

    .btn-login-trigger:hover {
      background: var(--accent);
      border-color: var(--accent);
    }

    /* ‚îÄ‚îÄ LOGIN MODAL ‚îÄ‚îÄ */
    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.6);
      backdrop-filter: blur(4px);
      z-index: 200;
      display: none;
      align-items: center;
      justify-content: center;
      animation: fadeIn 0.2s ease;
    }

    .modal-overlay.open { display: flex; }

    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

    .modal {
      background: var(--card-bg);
      border: 1px solid var(--border);
      padding: 48px 40px 40px;
      max-width: 400px;
      width: 90%;
      position: relative;
      animation: slideUp 0.25s ease;
    }

    @keyframes slideUp {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .modal-close {
      position: absolute;
      top: 16px;
      right: 16px;
      background: none;
      border: none;
      font-size: 1.2rem;
      cursor: pointer;
      color: var(--muted);
      line-height: 1;
      transition: color 0.2s;
    }

    .modal-close:hover { color: var(--ink); }

    .modal-eyebrow {
      font-size: 0.68rem;
      letter-spacing: 0.2em;
      text-transform: uppercase;
      color: var(--accent);
      font-weight: 500;
      margin-bottom: 10px;
    }

    .modal-title {
      font-family: 'Playfair Display', serif;
      font-size: 1.8rem;
      font-weight: 900;
      color: var(--ink);
      line-height: 1.1;
      margin-bottom: 8px;
    }

    .modal-subtitle {
      font-size: 0.85rem;
      color: var(--muted);
      line-height: 1.6;
      margin-bottom: 32px;
    }

    .login-divider {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 16px;
    }

    .login-divider .rule { flex: 1; height: 1px; background: var(--border); }
    .login-divider span {
      font-size: 0.68rem;
      letter-spacing: 0.1em;
      text-transform: uppercase;
      color: var(--muted);
    }

    .btn-provider {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 12px;
      width: 100%;
      padding: 14px 20px;
      border: 1px solid var(--border);
      background: var(--bg);
      color: var(--ink);
      font-family: 'DM Sans', sans-serif;
      font-size: 0.88rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
      text-decoration: none;
      margin-bottom: 10px;
      letter-spacing: 0.02em;
    }

    .btn-provider:hover {
      border-color: var(--ink);
      background: var(--ink);
      color: var(--bg);
    }

    .btn-provider:hover .provider-icon { filter: invert(1); }

    .btn-provider.github:hover {
      background: #24292e;
      border-color: #24292e;
      color: #fff;
    }

    .btn-provider.google:hover {
      background: #4285F4;
      border-color: #4285F4;
      color: #fff;
    }

    .btn-provider.google:hover .provider-icon { filter: none; }

    .provider-icon {
      width: 18px;
      height: 18px;
      flex-shrink: 0;
    }

    .modal-note {
      font-size: 0.72rem;
      color: var(--muted);
      text-align: center;
      margin-top: 20px;
      line-height: 1.5;
    }

    .masthead-title {
      text-align: center;
      padding-bottom: 16px;
    }

    .masthead-title h1 {
      font-family: 'Playfair Display', serif;
      font-size: clamp(2.8rem, 7vw, 5.5rem);
      font-weight: 900;
      letter-spacing: -0.02em;
      line-height: 1;
      color: var(--ink);
      transition: color 0.3s;
    }

    .masthead-title h1 span { color: var(--accent); }

    .masthead-subtitle {
      font-size: 0.78rem;
      letter-spacing: 0.25em;
      text-transform: uppercase;
      color: var(--muted);
      margin-top: 6px;
      font-weight: 400;
    }

    /* ‚îÄ‚îÄ SEARCH BAR ‚îÄ‚îÄ */
    .search-section {
      background: var(--search-bg);
      padding: 20px 40px;
      display: flex;
      align-items: center;
      gap: 16px;
      flex-wrap: wrap;
      transition: background 0.3s;
    }

    .search-label {
      font-family: 'Playfair Display', serif;
      font-size: 1rem;
      color: var(--bg);
      font-style: italic;
      white-space: nowrap;
    }

    .search-inner {
      display: flex;
      flex: 1;
      max-width: 620px;
    }

    .search-inner input {
      flex: 1;
      padding: 13px 20px;
      border: 2px solid #ffffff30;
      background: #ffffff10;
      color: #fff;
      font-family: 'DM Sans', sans-serif;
      font-size: 0.95rem;
      outline: none;
      border-right: none;
      transition: border-color 0.2s;
    }

    .search-inner input::placeholder { color: #ffffff50; }
    .search-inner input:focus { border-color: var(--accent); }

    .search-inner button {
      padding: 13px 28px;
      background: var(--accent);
      color: #fff;
      border: 2px solid var(--accent);
      font-family: 'DM Sans', sans-serif;
      font-size: 0.85rem;
      font-weight: 500;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      cursor: pointer;
      transition: background 0.2s;
      white-space: nowrap;
    }

    .search-inner button:hover { background: #a82d20; border-color: #a82d20; }

    /* ‚îÄ‚îÄ CATEGOR√çAS ‚îÄ‚îÄ */
    .categories {
      background: var(--bg);
      border-bottom: 1px solid var(--border);
      padding: 14px 40px;
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      align-items: center;
      transition: background 0.3s, border-color 0.3s;
    }

    .cat-label {
      font-size: 0.68rem;
      letter-spacing: 0.15em;
      text-transform: uppercase;
      color: var(--muted);
      font-weight: 500;
      margin-right: 4px;
    }

    .cat-btn {
      padding: 6px 16px;
      border: 1px solid var(--cat-border);
      background: var(--cat-bg);
      color: var(--ink);
      font-family: 'DM Sans', sans-serif;
      font-size: 0.78rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
      letter-spacing: 0.03em;
    }

    .cat-btn:hover, .cat-btn.active {
      background: var(--cat-hover);
      color: var(--cat-hover-color);
      border-color: var(--cat-hover);
    }

    /* ‚îÄ‚îÄ MAIN ‚îÄ‚îÄ */
    .container {
      max-width: 1100px;
      margin: 0 auto;
      padding: 40px 40px 60px;
    }

    .loading {
      display: none;
      text-align: center;
      padding: 80px 0;
    }

    .loading-text {
      font-family: 'Playfair Display', serif;
      font-size: 1.4rem;
      font-style: italic;
      color: var(--muted);
      animation: pulse 1.5s ease-in-out infinite;
    }

    @keyframes pulse { 0%, 100% { opacity: 0.5; } 50% { opacity: 1; } }

    .section-header {
      display: none;
      align-items: center;
      gap: 16px;
      margin-bottom: 32px;
      padding-bottom: 12px;
      border-bottom: 1px solid var(--border);
    }

    .section-header .rule { flex: 1; height: 1px; background: var(--border); }
    .section-header .label {
      font-size: 0.7rem;
      letter-spacing: 0.2em;
      text-transform: uppercase;
      color: var(--muted);
      font-weight: 500;
      white-space: nowrap;
    }
    .section-header .count {
      font-family: 'Playfair Display', serif;
      font-size: 0.85rem;
      color: var(--accent);
      font-style: italic;
    }

    /* ‚îÄ‚îÄ GRID ‚îÄ‚îÄ */
    #resultados {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 2px;
    }

    /* ‚îÄ‚îÄ CARD ‚îÄ‚îÄ */
    .card {
      background: var(--card-bg);
      padding: 28px;
      border: 1px solid var(--border);
      position: relative;
      transition: transform 0.2s, box-shadow 0.2s, background 0.3s, border-color 0.3s;
      animation: fadeUp 0.4s ease both;
      display: flex;
      flex-direction: column;
    }

    @keyframes fadeUp {
      from { opacity: 0; transform: translateY(16px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .card:hover {
      transform: translateY(-4px);
      box-shadow: 0 12px 40px rgba(0,0,0,0.12);
      z-index: 2;
    }

    .card:first-child {
      grid-column: 1 / -1;
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 32px;
      padding: 36px;
    }

    .card:first-child .card-num { font-size: 4rem; }
    .card:first-child .card-title { font-size: 1.55rem; }

    .card-num {
      font-family: 'Playfair Display', serif;
      font-size: 2rem;
      font-weight: 900;
      color: var(--border);
      line-height: 1;
      margin-bottom: 14px;
      display: block;
    }

    .card-tag {
      display: inline-block;
      background: var(--tag-bg);
      color: var(--tag-color);
      font-size: 0.65rem;
      letter-spacing: 0.18em;
      text-transform: uppercase;
      padding: 4px 10px;
      margin-bottom: 12px;
      font-weight: 500;
    }

    .card-title {
      font-family: 'Playfair Display', serif;
      font-size: 1.15rem;
      font-weight: 700;
      line-height: 1.35;
      color: var(--ink);
      margin-bottom: 12px;
    }

    .card-desc {
      font-size: 0.875rem;
      color: var(--muted);
      line-height: 1.7;
      flex: 1;
      margin-bottom: 20px;
    }

    .card-footer {
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-top: 1px solid var(--border);
      padding-top: 14px;
      margin-top: auto;
      gap: 8px;
    }

    .fuente {
      font-size: 0.72rem;
      letter-spacing: 0.1em;
      text-transform: uppercase;
      color: var(--muted);
      font-weight: 500;
      flex: 1;
    }

    .card-actions {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .btn-fav, .btn-share {
      background: none;
      border: none;
      cursor: pointer;
      font-size: 1.1rem;
      padding: 2px;
      line-height: 1;
      transition: transform 0.15s;
      color: var(--muted);
    }

    .btn-fav:hover, .btn-share:hover { transform: scale(1.2); }
    .btn-fav.saved { color: var(--accent); }

    .leer-mas {
      color: var(--accent);
      text-decoration: none;
      font-size: 0.8rem;
      font-weight: 500;
      letter-spacing: 0.05em;
      display: flex;
      align-items: center;
      gap: 6px;
      transition: gap 0.2s;
      white-space: nowrap;
    }

    .leer-mas:hover { gap: 10px; }
    .leer-mas::after { content: '‚Üí'; font-size: 1rem; }

    /* ‚îÄ‚îÄ SHARE POPUP ‚îÄ‚îÄ */
    .share-popup {
      position: fixed;
      bottom: 30px;
      left: 50%;
      transform: translateX(-50%) translateY(20px);
      background: var(--ink);
      color: var(--bg);
      padding: 10px 22px;
      font-size: 0.82rem;
      letter-spacing: 0.05em;
      pointer-events: none;
      opacity: 0;
      transition: all 0.3s;
      z-index: 100;
      white-space: nowrap;
    }

    .share-popup.show {
      opacity: 1;
      transform: translateX(-50%) translateY(0);
    }

    /* ‚îÄ‚îÄ EMPTY / INITIAL ‚îÄ‚îÄ */
    .empty, .initial {
      grid-column: 1 / -1;
      text-align: center;
      padding: 100px 0;
    }

    .initial { border: 1px dashed var(--border); }

    .empty-num {
      font-family: 'Playfair Display', serif;
      font-size: 8rem;
      font-weight: 900;
      color: var(--border);
      line-height: 1;
    }

    .empty-text, .initial-text {
      font-family: 'Playfair Display', serif;
      font-size: 1.2rem;
      font-style: italic;
      color: var(--muted);
      margin-top: 8px;
    }

    .initial-icon {
      font-size: 3rem;
      display: block;
      margin-bottom: 16px;
      opacity: 0.4;
    }

    @media (max-width: 700px) {
      .masthead, .categories { padding: 16px 20px 0; }
      .search-section { padding: 16px 20px; }
      .container { padding: 24px 20px 40px; }
      .card:first-child { grid-template-columns: 1fr; gap: 0; }
      .card:first-child .card-num { font-size: 2rem; }
      .categories { padding: 14px 20px; }
      .modal { padding: 40px 24px 32px; }
    }
  </style>
</head>
<body>

<!-- ‚îÄ‚îÄ LOGIN MODAL ‚îÄ‚îÄ -->
<div class="modal-overlay" id="login-modal" onclick="handleOverlayClick(event)">
  <div class="modal">
    <button class="modal-close" onclick="closeLoginModal()" title="Cerrar">‚úï</button>
    <p class="modal-eyebrow">Acceso</p>
    <h2 class="modal-title">Iniciar sesi√≥n</h2>
    <p class="modal-subtitle">Guard√° tus art√≠culos favoritos y acced√© desde cualquier dispositivo.</p>

    <div class="login-divider">
      <div class="rule"></div>
      <span>Continuar con</span>
      <div class="rule"></div>
    </div>

    <!-- GitHub -->
    <a class="btn-provider github" href="/.auth/login/github?post_login_redirect_uri=/">
      <svg class="provider-icon" viewBox="0 0 24 24" fill="currentColor">
        <path d="M12 0C5.37 0 0 5.37 0 12c0 5.31 3.435 9.795 8.205 11.385.6.105.825-.255.825-.57 0-.285-.015-1.23-.015-2.235-3.015.555-3.795-.735-4.035-1.41-.135-.345-.72-1.41-1.23-1.695-.42-.225-1.02-.78-.015-.795.945-.015 1.62.87 1.845 1.23 1.08 1.815 2.805 1.305 3.495.99.105-.78.42-1.305.765-1.605-2.67-.3-5.46-1.335-5.46-5.925 0-1.305.465-2.385 1.23-3.225-.12-.3-.54-1.53.12-3.18 0 0 1.005-.315 3.3 1.23.96-.27 1.98-.405 3-.405s2.04.135 3 .405c2.295-1.56 3.3-1.23 3.3-1.23.66 1.65.24 2.88.12 3.18.765.84 1.23 1.905 1.23 3.225 0 4.605-2.805 5.625-5.475 5.925.435.375.81 1.095.81 2.22 0 1.605-.015 2.895-.015 3.3 0 .315.225.69.825.57A12.02 12.02 0 0 0 24 12c0-6.63-5.37-12-12-12z"/>
      </svg>
      Continuar con GitHub
    </a>

    <!-- Google -->
    <a class="btn-provider google" href="/.auth/login/google?post_login_redirect_uri=/">
      <svg class="provider-icon" viewBox="0 0 24 24">
        <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
        <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
        <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
        <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
      </svg>
      Continuar con Google
    </a>

    <p class="modal-note">Al iniciar sesi√≥n acept√°s los t√©rminos de uso del servicio.</p>
  </div>
</div>

<div class="masthead">
  <div class="masthead-top">
    <span class="date-line" id="fecha-hoy"></span>
    <div class="masthead-controls">
      <button class="fav-toggle" id="fav-toggle-btn" onclick="toggleFavView()">‚ô• Favoritos (<span id="fav-count">0</span>)</button>

      <!-- Auth area -->
      <div class="user-auth">
        <!-- Logged in state -->
        <div class="user-info" id="user-info">
          <img class="user-avatar" id="user-avatar" src="" alt="Avatar" />
          <span class="user-name" id="user-name"></span>
          <a class="btn-logout" href="/.auth/logout?post_logout_redirect_uri=/">Salir</a>
        </div>
        <!-- Logged out state -->
        <button class="btn-login-trigger" id="btn-login-trigger" onclick="openLoginModal()">
          ‚Üó Iniciar sesi√≥n
        </button>
      </div>

      <button class="theme-btn" id="theme-btn" onclick="toggleTheme()" title="Cambiar tema">üåô</button>
    </div>
  </div>
  <div class="masthead-title">
    <h1>THE <span>NEWS</span> BOT</h1>
    <p class="masthead-subtitle">Noticias en tiempo real ¬∑ Buscador inteligente</p>
  </div>
</div>

<div class="search-section">
  <span class="search-label">Buscar tema:</span>
  <div class="search-inner">
    <input type="text" id="input-tema" placeholder="Ej: inteligencia artificial, clima, econom√≠a..." />
    <button onclick="buscarNoticias()">Buscar</button>
  </div>
</div>

<div class="categories">
  <span class="cat-label">R√°pido:</span>
  <button class="cat-btn" onclick="buscarCategoria(this, 'tecnolog√≠a')">üíª Tecnolog√≠a</button>
  <button class="cat-btn" onclick="buscarCategoria(this, 'deportes')">‚öΩ Deportes</button>
  <button class="cat-btn" onclick="buscarCategoria(this, 'econom√≠a')">üìà Econom√≠a</button>
  <button class="cat-btn" onclick="buscarCategoria(this, 'pol√≠tica')">üèõÔ∏è Pol√≠tica</button>
  <button class="cat-btn" onclick="buscarCategoria(this, 'ciencia')">üî¨ Ciencia</button>
  <button class="cat-btn" onclick="buscarCategoria(this, 'entretenimiento')">üé¨ Entretenimiento</button>
  <button class="cat-btn" onclick="buscarCategoria(this, 'mundo')">üåç Mundo</button>
</div>

<div class="container">
  <div class="loading" id="loading">
    <p class="loading-text">Recopilando noticias...</p>
  </div>

  <div class="section-header" id="section-header">
    <div class="rule"></div>
    <span class="label">Resultados para</span>
    <span class="count" id="tema-label"></span>
    <div class="rule"></div>
    <span class="label" id="count-label"></span>
    <div class="rule"></div>
  </div>

  <div id="resultados">
    <div class="initial">
      <span class="initial-icon">üì∞</span>
      <p class="initial-text">Ingres√° un tema o eleg√≠ una categor√≠a para comenzar</p>
    </div>
  </div>
</div>

<div class="share-popup" id="share-popup">‚úì Link copiado al portapapeles</div>

<script>
  // ‚îÄ‚îÄ FECHA ‚îÄ‚îÄ
  const now = new Date();
  document.getElementById('fecha-hoy').textContent = now.toLocaleDateString('es-AR', {
    weekday: 'long', year: 'numeric', month: 'long', day: 'numeric'
  });

  // ‚îÄ‚îÄ TEMA OSCURO/CLARO ‚îÄ‚îÄ
  let darkMode = localStorage.getItem('theme') === 'dark';
  applyTheme();

  function toggleTheme() {
    darkMode = !darkMode;
    localStorage.setItem('theme', darkMode ? 'dark' : 'light');
    applyTheme();
  }

  function applyTheme() {
    document.documentElement.setAttribute('data-theme', darkMode ? 'dark' : 'light');
    document.getElementById('theme-btn').textContent = darkMode ? '‚òÄÔ∏è' : 'üåô';
  }

  // ‚îÄ‚îÄ AUTH: leer usuario desde /.auth/me ‚îÄ‚îÄ
  async function checkAuth() {
    try {
      const res = await fetch('/.auth/me');
      const data = await res.json();
      const user = data?.clientPrincipal;

      if (user) {
        document.getElementById('user-info').style.display = 'flex';
        document.getElementById('btn-login-trigger').style.display = 'none';

        const name = user.userDetails || user.userId || 'Usuario';
        document.getElementById('user-name').textContent = name;

        // Avatar: si el provider es github se puede construir la URL del avatar
        if (user.identityProvider === 'github') {
          const login = user.userDetails;
          document.getElementById('user-avatar').src = `https://avatars.githubusercontent.com/${login}`;
        } else {
          document.getElementById('user-avatar').src = `https://ui-avatars.com/api/?name=${encodeURIComponent(name)}&background=c8392b&color=fff&size=60`;
        }
      }
    } catch (e) {
      // No autenticado o endpoint no disponible en local
    }
  }

  checkAuth();

  // ‚îÄ‚îÄ MODAL LOGIN ‚îÄ‚îÄ
  function openLoginModal() {
    document.getElementById('login-modal').classList.add('open');
    document.body.style.overflow = 'hidden';
  }

  function closeLoginModal() {
    document.getElementById('login-modal').classList.remove('open');
    document.body.style.overflow = '';
  }

  function handleOverlayClick(e) {
    if (e.target === document.getElementById('login-modal')) closeLoginModal();
  }

  document.addEventListener('keydown', e => {
    if (e.key === 'Escape') closeLoginModal();
  });

  // ‚îÄ‚îÄ FAVORITOS ‚îÄ‚îÄ
  let favoritos = JSON.parse(localStorage.getItem('favoritos') || '[]');
  let viendoFavoritos = false;
  updateFavCount();

  function updateFavCount() {
    document.getElementById('fav-count').textContent = favoritos.length;
  }

  function toggleFav(btn, noticia) {
    const idx = favoritos.findIndex(f => f.url === noticia.url);
    if (idx === -1) {
      favoritos.push(noticia);
      btn.classList.add('saved');
      btn.textContent = '‚ô•';
    } else {
      favoritos.splice(idx, 1);
      btn.classList.remove('saved');
      btn.textContent = '‚ô°';
    }
    localStorage.setItem('favoritos', JSON.stringify(favoritos));
    updateFavCount();
  }

  function isFav(url) {
    return favoritos.some(f => f.url === url);
  }

  function toggleFavView() {
    viendoFavoritos = !viendoFavoritos;
    document.getElementById('fav-toggle-btn').classList.toggle('active', viendoFavoritos);
    document.querySelectorAll('.cat-btn').forEach(b => b.classList.remove('active'));

    if (viendoFavoritos) {
      mostrarNoticias(favoritos, '‚ù§Ô∏è Mis favoritos');
    } else {
      document.getElementById('resultados').innerHTML = `
        <div class="initial">
          <span class="initial-icon">üì∞</span>
          <p class="initial-text">Ingres√° un tema o eleg√≠ una categor√≠a para comenzar</p>
        </div>`;
      document.getElementById('section-header').style.display = 'none';
    }
  }

  // ‚îÄ‚îÄ COMPARTIR ‚îÄ‚îÄ
  function compartir(url) {
    navigator.clipboard.writeText(url).then(() => {
      const popup = document.getElementById('share-popup');
      popup.classList.add('show');
      setTimeout(() => popup.classList.remove('show'), 2500);
    });
  }

  // ‚îÄ‚îÄ CATEGOR√çAS ‚îÄ‚îÄ
  function buscarCategoria(btn, cat) {
    document.querySelectorAll('.cat-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    document.getElementById('input-tema').value = cat;
    buscarNoticias();
  }

  // ‚îÄ‚îÄ ENTER KEY ‚îÄ‚îÄ
  document.getElementById("input-tema").addEventListener("keypress", function(e) {
    if (e.key === "Enter") buscarNoticias();
  });

  // ‚îÄ‚îÄ RENDER ‚îÄ‚îÄ
  function mostrarNoticias(noticias, temaLabel) {
    const resultados = document.getElementById("resultados");
    const sectionHeader = document.getElementById("section-header");

    if (noticias.length === 0) {
      resultados.innerHTML = `
        <div class="empty">
          <div class="empty-num">0</div>
          <p class="empty-text">No hay noticias aqu√≠ todav√≠a.</p>
        </div>`;
      sectionHeader.style.display = 'none';
      return;
    }

    sectionHeader.style.display = 'flex';
    document.getElementById("tema-label").textContent = `"${temaLabel}"`;
    document.getElementById("count-label").textContent = `${noticias.length} art√≠culos`;

    resultados.innerHTML = '';
    noticias.forEach((n, i) => {
      const saved = isFav(n.url);
      const card = document.createElement('div');
      card.className = 'card';
      card.style.animationDelay = `${i * 60}ms`;
      card.innerHTML = `
        <div>
          <span class="card-num">${String(i + 1).padStart(2, '0')}</span>
          <span class="card-tag">${n.fuente}</span>
          <h2 class="card-title">${n.titulo}</h2>
          <p class="card-desc">${n.descripcion || "Sin descripci√≥n disponible."}</p>
        </div>
        <div class="card-footer">
          <span class="fuente">${n.fuente}</span>
          <div class="card-actions">
            <button class="btn-fav ${saved ? 'saved' : ''}" title="${saved ? 'Quitar de favoritos' : 'Guardar en favoritos'}">${saved ? '‚ô•' : '‚ô°'}</button>
            <button class="btn-share" title="Copiar link">‚Üó</button>
            <a class="leer-mas" href="${n.url}" target="_blank">Leer</a>
          </div>
        </div>`;

      card.querySelector('.btn-fav').addEventListener('click', function() {
        toggleFav(this, n);
      });
      card.querySelector('.btn-share').addEventListener('click', function() {
        compartir(n.url);
      });

      resultados.appendChild(card);
    });
  }

  // ‚îÄ‚îÄ BUSCAR ‚îÄ‚îÄ
  async function buscarNoticias() {
    const tema = document.getElementById("input-tema").value.trim();
    if (!tema) return;

    viendoFavoritos = false;
    document.getElementById('fav-toggle-btn').classList.remove('active');

    const loading = document.getElementById("loading");
    const resultados = document.getElementById("resultados");
    const sectionHeader = document.getElementById("section-header");

    loading.style.display = "block";
    resultados.innerHTML = "";
    sectionHeader.style.display = "none";

    try {
      const res = await fetch(`https://bot-noticias-func.azurewebsites.net/api/obtener-noticias?tema=${encodeURIComponent(tema)}`);
      const noticias = await res.json();
      loading.style.display = "none";
      mostrarNoticias(noticias, tema);
    } catch (err) {
      loading.style.display = "none";
      resultados.innerHTML = `
        <div class="empty">
          <div class="empty-num">!</div>
          <p class="empty-text">Error al conectar con el servidor.</p>
        </div>`;
    }
  }
</script>
</body>
</html>